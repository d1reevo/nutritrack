# Архитектура приложения

## Общая структура

```
User (Браузер)
    ↓↑
Frontend (React + Tailwind)
    ↓↑ (HTTP/REST)
Backend (Express + TypeScript)
    ↓↑
SQLite Database
    ↓↑
Gemini API
```

## Слой Frontend

### Компоненты
- **Navbar** - навигация сверху
- **Sidebar** - боковое меню
- **Modal** - модальные окна
- **Alert** - уведомления
- **Cards** - карточки (дни, приёмы пищи)
- **Charts** - графики (вес, калории)
- **ProgressBar** - полоса прогресса

### Страницы
1. **OnboardingPage** - первичная настройка профиля
2. **DashboardPage** - главная страница с показателями дня
3. **MealsPage** - список приёмов пищи по дням
4. **ProgressPage** - анализ прогресса и графики
5. **SettingsPage** - редактирование профиля

### Сервисы
- **api.ts** - клиент для общения с бэкендом (Axios)
- **themeUtils.ts** - управление светлой/тёмной темой
- **hooks** - Custom React hooks

## Слой Backend

### Контроллеры
- **ProfileController** - управление профилем пользователя
- **MealController** - управление приёмами пищи и днями
- **ProgressController** - управление измерениями и геймификацией
- **AIController** - интеграция с ИИ и оценки прогресса

### Сервисы
- **AIService** - интеграция с Gemini API
  - Анализ пищи (текст → продукты → калории)
  - Оценка дня
  - Анализ прогресса
  - Генерация дневных заданий
  
- **NutritionService** - расчёты по питанию
  - Формула Mifflin-St Jeor (дневная норма калорий)
  - Определение оценки дня
  - Расчёт достижений
  - Система уровней и XP

### Маршруты
- `POST /api/profile` - создание профиля
- `GET /api/profile` - получение профиля
- `POST /api/days/:date/meals` - добавление приёма пищи (с анализом ИИ)
- `GET /api/days` - список дней
- `GET /api/days/:date` - подробная информация дня
- `PUT/DELETE /api/meals/:id` - редактирование/удаление
- `POST /api/progress/measurements` - добавление измерения
- `GET /api/ai/progress/summary` - получение оценки прогресса
- `POST /api/ai/recompute-progress` - пересчёт оценки
- `GET /api/ai/daily-quest` - дневное задание

## Слой БД (Prisma)

### Модели
1. **UserProfile** - профиль пользователя
2. **Day** - день с итогами
3. **MealEntry** - приём пищи
4. **BodyMeasurement** - измерения тела
5. **GamificationState** - статус геймификации
6. **ProgressSummaryCache** - кеш оценки прогресса

### Связи
```
UserProfile
  ├── Day[] (один ко многим)
  ├── BodyMeasurement[] (один ко многим)
  ├── GamificationState (один к одному)
  └── ProgressSummaryCache (один к одному)

Day
  ├── UserProfile (many to one)
  └── MealEntry[] (один ко многим)

MealEntry
  └── Day (many to one)

BodyMeasurement
  └── UserProfile (many to one)
```

## Поток данных

### Добавление приёма пищи
```
User вводит текст → Frontend POST /api/days/:date/meals
  ↓
Backend запускает AIService.analyzeMeal()
  ↓
Gemini API анализирует текст → JSON с продуктами и калориями
  ↓
MealController сохраняет MealEntry в БД
  ↓
Пересчитываются итоги Day (сумма калорий, БЖУ)
  ↓
AIService.evaluateDay() оценивает день
  ↓
Обновляется GamificationState (XP, streak, achievements)
  ↓
Frontend получает данные и отображает результат
```

### Пересчёт прогресса
```
User нажимает "Обновить оценку" → Frontend POST /api/ai/recompute-progress
  ↓
AIController собирает данные за весь период
  - Все дни пользователя
  - Все измерения (вес)
  - Статус геймификации
  ↓
AIService.generateProgressSummary() отправляет в Gemini
  ↓
Gemini возвращает развёрнутую оценку с советами
  ↓
Результат сохраняется в ProgressSummaryCache
  ↓
Frontend отображает оценку с графиками
```

## Геймификация

### XP система
- +5 XP за каждый добавленный приём пищи
- +15 XP за день с хотя бы одной записью
- +25 XP за день в норме калорий
- +50 XP за новую ачивку

### Уровни
- Уровень = (XP ÷ 100) + 1
- Максимум без лимита

### Стрик
- Трекится по дате последней активности
- Активность = хотя бы одна запись в день
- При пропуске дня стрик сбрасывается на 1

### Достижения
Автоматически разблокируются при:
- 7 дней подряд в дневнике
- 7 дней подряд в норме калорий
- Каждый килограмм потери веса
- Определённые количества дней активности

## Безопасность

### Текущие меры
- Валидация всех входных данных
- Обработка ошибок на всех уровнях
- Нет хранения пароля (один пользователь)
- CORS для безопасности

### Возможные улучшения
- HTTPS в production
- Rate limiting на API
- Input sanitization
- JWT токены (если добавится многопользовательность)

## Производительность

### Оптимизации
- Кеширование прогресса (не пересчитывается каждый раз)
- Индексы на часто используемых полях
- Lazy loading на фронтенде
- Эффективные запросы к БД

### Возможные улучшения
- Кеширование API ответов на фронтенде
- Pagination для больших списков
- Компрессия БД
- Batch операции при множественных обновлениях
